<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–æ–∑–∞ –≤ –ù–∏–∂–Ω–µ–º - Telegram Game</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Telegram-specific styles */
        body {
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #0a1538, #1a1a5e);
            overflow: hidden;
        }
        
        .telegram-footer {
            display: none !important;
        }
        
        /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è Telegram */
        #game {
            height: 85vh !important;
            max-height: 85vh !important;
            border-width: 5px !important;
            margin-top: 0 !important;
        }
        
        .tg-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .tg-buttons button {
            flex: 1;
            padding: 15px 10px !important;
            font-size: 16px !important;
            min-width: auto !important;
        }
    </style>
</head>
<body>
    <div class="container" style="width: 100%; max-width: 100%;">
        <div id="game">
            <div id="score">0</div>
            
            <div id="startScreen">
                <h1 style="font-size: 28px !important;">üêê –ö–æ–∑–∞ –≤ –ù–∏–∂–Ω–µ–º</h1>
                <p class="subtitle" style="font-size: 18px !important;">–¢–µ–ø–µ—Ä—å –≤ Telegram!</p>
                
                <div class="simple-instructions">
                    <p>–¢–∞–ø–Ω–∏ —á—Ç–æ–±—ã –ª–µ—Ç–µ—Ç—å</p>
                </div>
                
                <button id="startBtn" style="font-size: 24px !important; padding: 18px 40px !important;">–°–¢–ê–†–¢</button>
                
                <div class="high-score">
                    <p>üèÜ –†–µ–∫–æ—Ä–¥: <span id="currentHighScore">0</span></p>
                </div>
                
                <!-- Telegram features -->
                <div id="tgUserInfo" style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; display: none;">
                    <p id="tgUsername" style="margin: 5px 0; font-size: 16px;"></p>
                    <p id="tgBestScore" style="margin: 5px 0; font-size: 16px;"></p>
                </div>
            </div>
            
            <div id="gameOverScreen" style="display: none;">
                <h2 style="font-size: 26px !important;">üí• –£–ø–∞–ª!</h2>
                
                <div class="final-scores">
                    <div class="score-row">
                        <span>–¢–≤–æ–π —Å—á–µ—Ç:</span>
                        <span class="score-value" id="finalScore">0</span>
                    </div>
                    <div class="score-row">
                        <span>–†–µ–∫–æ—Ä–¥:</span>
                        <span class="score-value" id="highScore">0</span>
                    </div>
                </div>
                
                <button id="restartBtn" style="font-size: 22px !important; padding: 15px 30px !important;">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
                
                <p class="game-tip">–õ–µ—Ç–∏ –≤—ã—à–µ –ø—Ç–∏—Ü, –Ω–∏–∂–µ –ª–∞–≤–æ—á–µ–∫!</p>
                
                <!-- Telegram Share Buttons -->
                <div class="tg-buttons">
                    <button id="tgShareBtn" style="background: #0088cc; border-color: #00ccff;">
                        üì¢ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                    </button>
                    <button id="tgChannelBtn" style="background: #FF8C00; border-color: #FFD700;">
                        üì¢ –ù–∞—à –∫–∞–Ω–∞–ª
                    </button>
                </div>
            </div>
            
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <!-- Telegram Integration Script -->
    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // Expand to full screen
        tg.expand();
        
        // Set Telegram theme colors
        tg.setHeaderColor('#0a1538');
        tg.setBackgroundColor('#0a1538');
        
        // Configure Main Button
        tg.MainButton.setText('üîô –ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É');
        tg.MainButton.onClick(() => tg.close());
        tg.MainButton.show();
        
        // Get user info
        const user = tg.initDataUnsafe?.user;
        if (user) {
            console.log('Telegram User:', user);
            
            // Show user info
            const userInfoEl = document.getElementById('tgUserInfo');
            const usernameEl = document.getElementById('tgUsername');
            const bestScoreEl = document.getElementById('tgBestScore');
            
            if (userInfoEl && usernameEl) {
                userInfoEl.style.display = 'block';
                usernameEl.textContent = `–ò–≥—Ä–æ–∫: ${user.first_name || '–ì–æ—Å—Ç—å'}`;
                if (user.username) {
                    usernameEl.textContent += ` (@${user.username})`;
                }
                
                // Try to get best score from localStorage with user prefix
                const userBestScore = localStorage.getItem(`tg_${user.id}_best_score`) || 0;
                bestScoreEl.textContent = `–õ—É—á—à–∏–π: ${userBestScore} –æ—á–∫–æ–≤`;
                
                // Update current high score display
                document.getElementById('currentHighScore').textContent = userBestScore;
            }
        }
        
        // Share function
        function shareGame() {
            const score = document.getElementById('finalScore')?.textContent || '0';
            const shareText = `üéÆ –Ø –Ω–∞–±—Ä–∞–ª ${score} –æ—á–∫–æ–≤ –≤ –∏–≥—Ä–µ "–ö–æ–∑–∞ –≤ –ù–∏–∂–Ω–µ–º"! –°–º–æ–∂–µ—à—å –ø–æ–±–∏—Ç—å?`;
            
            if (tg.shareGame) {
                tg.shareGame({
                    title: '–ö–æ–∑–∞ –≤ –ù–∏–∂–Ω–µ–º',
                    text: shareText,
                    url: 'https://t.me/vnizhnem_est'
                });
            } else {
                tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/vnizhnem_est&text=${encodeURIComponent(shareText)}`);
            }
        }
        
        // Open channel
        function openChannel() {
            tg.openTelegramLink('https://t.me/vnizhnem_est');
        }
        
        // Save score to Telegram cloud (simulated)
        function saveScoreToTelegram(score) {
            if (user) {
                // Save locally with user prefix
                const currentBest = localStorage.getItem(`tg_${user.id}_best_score`) || 0;
                if (score > currentBest) {
                    localStorage.setItem(`tg_${user.id}_best_score`, score);
                }
                
                // Send data to bot (simplified version)
                tg.sendData(JSON.stringify({
                    action: 'save_score',
                    user_id: user.id,
                    username: user.username || user.first_name || 'anonymous',
                    score: score
                }));
            }
        }
        
        // Attach event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Share button
            document.getElementById('tgShareBtn')?.addEventListener('click', shareGame);
            
            // Channel button
            document.getElementById('tgChannelBtn')?.addEventListener('click', openChannel);
            
            // Modify game's endGame function
            const originalEndGame = window.endGame;
            if (typeof originalEndGame === 'function') {
                window.endGame = function() {
                    // Call original
                    originalEndGame();
                    
                    // Telegram specific actions
                    const finalScore = parseInt(document.getElementById('finalScore')?.textContent || '0');
                    saveScoreToTelegram(finalScore);
                    
                    // Show Telegram buttons
                    const tgButtons = document.querySelector('.tg-buttons');
                    if (tgButtons) tgButtons.style.display = 'flex';
                };
            }
        });
    </script>
    
    <!-- Original Game Script -->
    <script src="game.js"></script>
    
    <script>
        // Adjust game for Telegram
        document.addEventListener('DOMContentLoaded', function() {
            // Resize canvas for Telegram
            setTimeout(() => {
                if (typeof resizeCanvas === 'function') {
                    resizeCanvas();
                }
            }, 100);
            
            // Load high score for Telegram user
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const userId = window.Telegram.WebApp.initDataUnsafe.user.id;
                const tgBestScore = localStorage.getItem(`tg_${userId}_best_score`) || 0;
                document.getElementById('currentHighScore').textContent = tgBestScore;
            }
        });
    </script>
</body>
</html>